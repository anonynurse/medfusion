<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Medfusion</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; padding:16px; }
    #page { margin:auto; width:100%; max-width:900px; }
    .row { display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .col { display:flex; align-items:center; gap:8px; }
    button { padding:10px 14px; border:1px solid #ccc; border-radius:8px; background:#f6f6f6; cursor:pointer; }
    button:hover { background:#eee; }
    textarea { width:100%; height:60vh; font-size:7pt; }
    input[type="text"] { width:6ch; text-align:center; }
    .small { font-size:12px; color:#666; }
  </style>
</head>
<body>
  <div id="page">
    <div class="row" style="margin-bottom:8px;">
      <div class="col" style="flex:1;">
        <button id="play" style="flex:1;">Play</button>
      </div>
      <div class="col" style="flex:1; justify-content:flex-end;">
        <button id="step" style="flex:1;">Step</button>
      </div>
    </div>

    <div class="row" style="margin-bottom:8px;">
      <div class="col">
        <button id="scorebtn">mistake</button>
        <input id="score" type="text" value="0" read-only>
      </div>
      <div class="col">
        <input type="checkbox" id="soundCheckbox" checked>
        <label for="soundCheckbox">sound</label>
        <span class="small" id="status"></span>
      </div>
    </div>
  </br>
    <div id="txtarea">
      <textarea id="textArea">
review chart and mar
! hand hygiene
verbalize PPE
introduce self
*** verify patient bracelet to mar, name dob mrn
verify allergies
inform patient of intent
get consent
ask about health status
ask about symptoms and main complaint
ask about last meds time and affect
take vitals: RR, HR, T, O2, BP
pain assessment
! IV assessment
  solution and rate match orders
  dressing dry and intact
  Touch - temp change
  Look - dry and visible
  Compare - opposite side
inform family will return with medication
! leave room hand hygiene
gather materials
   saline flush
   secondary tubing set
   alcohol swabs
   right medication
   compare med with mar
*** 6 rights with mar
   patient
   medication
   dose (with cheo guide)
   time and interval
   route
   reason
confirm pre-filled med is right volume
using manual verify usual dosage
calculate safe dose max and min with cheo guide 
verify dilution with manual for intermittent iv
verify infusion time with manual
select time within manual limits
calculate infusion rate
! confirm med is compatible with current iv solution
verify precautions before med from hazards in manual
prime tubing with flush
attach tubing to med syringe
*** 6 rights with mar
   patient
   medication
   dose (with cheo guide)
   time and interval
   route
   reason
! enter room hand hygiene
bring all equipment to bedside
inform patient of med, reason, action, hazards
allow questions
encourage family to call if side effects
*** 6 rights with patient
   patient (mar and bracelet)
   medication
   dose
   date time and interval
   route
   reason
put medication into pump
*** program pump 
   right med
   patient weight
   size of syringe
   dose
   rate
disinfect y port on iv tubing
insert med line into y port
press start on medication and verify 
inform patient med has started
! leave room and perform hand hygiene
      </textarea>
    </div>
  </div>

  <audio id="ttsAudio" preload="auto"></audio>

  <script>
    // Replace with your Worker URL:
    const WORKER_URL = "https://postpartum-tts.chris8331.workers.dev/api/tts"; 
    const VOICE = "en-US-JennyNeural";
    const FORMAT = "audio-24khz-48kbitrate-mono-mp3";

    let lines = [];
    let index = 0;
    let playing = false;

    const playBtn = document.getElementById("play");
    const stepBtn = document.getElementById("step");
    const scoreBtn = document.getElementById("scorebtn");
    const scoreInput = document.getElementById("score");
    const textArea = document.getElementById("textArea");
    const soundCheckbox = document.getElementById("soundCheckbox");
    const audioEl = document.getElementById("ttsAudio");
    const statusEl = document.getElementById("status");

    function setStatus(msg) { statusEl.textContent = msg || ""; }

    async function speak(text) {
      if (!soundCheckbox.checked || !text.trim()) return;

      // Try Cloud TTS
      try {
        setStatus("cloud TTS…");
        const res = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text, voice: VOICE, format: FORMAT })
        });
        if (!res.ok) throw new Error(await res.text());
        const blob = await res.blob();
        if (blob.size < 2000) throw new Error("Empty audio");
        audioEl.src = URL.createObjectURL(blob);
        await audioEl.play();
        setStatus("");
        return; // success
      } catch (err) {
        console.warn("Cloud TTS failed, falling back:", err);
        setStatus("cloud TTS failed → local voice");
      }

      // Fallback: browser speechSynthesis
      try {
        const utter = new SpeechSynthesisUtterance(text);
        const voices = speechSynthesis.getVoices();
        utter.voice = voices.find(v => v.lang === "en-US") || voices.find(v => v.lang.startsWith("en")) || null;
        utter.rate = 1.0;
        utter.pitch = 1.0;
        speechSynthesis.speak(utter);
      } catch (err) {
        console.error("Local TTS also failed:", err);
        setStatus("all TTS failed");
      }
    }

    playBtn.addEventListener("click", function() {
      if (playing) return;
      playing = true;
      lines = textArea.value.split("\n");
      textArea.value = "";
      index = 0;
      playLines();
    });

    stepBtn.addEventListener("click", function() {
      if (index === 0) {
        lines = textArea.value.split("\n");
        textArea.value = "";
      }
      if (index <= lines.length && index !== 0) {
        const line = lines[index - 1];
        textArea.value += line + "\n";
        textArea.scrollTop = textArea.scrollHeight;
        speak(line);
      }
      index++;
    });

    scoreBtn.addEventListener("click", function() {
      scoreInput.value = parseInt(scoreInput.value, 10) + 1;
      textArea.value += "*** ^ ***\n";
    });

    function playLines() {
      if (index >= lines.length) {
        playing = false;
        return;
      }
      const line = lines[index];
      textArea.value += line + "\n";
      textArea.scrollTop = textArea.scrollHeight;
      speak(line);
      index++;
      setTimeout(playLines, 3000);
    }
  </script>
</body>
</html>
